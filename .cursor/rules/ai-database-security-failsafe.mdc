---
name: ai-database-security-failsafe
description: MANDATORY failsafe hook - AI must halt and apply security patterns for ANY $wpdb usage. FORCE LOADS database-security-reference.mdc and security-database.mdc for complete implementation.
globs:
  - Dashboard/**/*.php
  - "**/*.php"
alwaysApply: true
---

## ðŸ”’ **MANDATORY DATABASE SECURITY FAILSAFE - TOKEN OPTIMIZED**

### **ðŸš¨ CRITICAL AUTO-TRIGGER PROTOCOL**

**WHEN AI DETECTS ANY `$wpdb` PATTERN, IT MUST:**
1. **HALT** code generation immediately
2. **FORCE LOAD** database-security-reference.mdc (mandatory context)
3. **FORCE LOAD** security-database.mdc (mandatory patterns)
4. **APPLY** complete security implementation from ALL files
5. **VALIDATE** using checklist below
6. **RESUME** only with secure implementation

### **ðŸŽ¯ MANDATORY CROSS-FILE LOADING TRIGGERS**

```php
// AUTO-TRIGGER PATTERNS - MUST LOAD ALL 3 FILES
$wpdb->prepare()             // â†’ LOAD: security-database.mdc + database-security-reference.mdc
$wpdb->get_results()         // â†’ LOAD: security-database.mdc + database-security-reference.mdc  
$wpdb->insert()              // â†’ LOAD: security-database.mdc + database-security-reference.mdc
$wpdb->update()              // â†’ LOAD: security-database.mdc + database-security-reference.mdc
$wpdb->delete()              // â†’ LOAD: security-database.mdc + database-security-reference.mdc
Dashboard_Security_Database  // â†’ LOAD: database-security-reference.mdc (implementation context)
get_db()                     // â†’ LOAD: database-security-reference.mdc (helper patterns)
"migration"                  // â†’ LOAD: database-security-reference.mdc (complex scenarios)
"error handling"             // â†’ LOAD: database-security-reference.mdc (implementation needs)
```

### **âš¡ EMERGENCY FAILSAFE ENFORCEMENT**

```
IF AI generates database code WITHOUT loading all required files:
â”œâ”€ SECURITY VIOLATION DETECTED
â”œâ”€ HALT: Stop code generation immediately
â”œâ”€ FORCE LOAD: database-security-reference.mdc (MANDATORY)
â”œâ”€ FORCE LOAD: security-database.mdc (MANDATORY)  
â”œâ”€ REPROCESS: Apply patterns from all loaded files
â””â”€ VALIDATE: Complete security checklist before proceeding
```

### **ðŸ›¡ï¸ COMPREHENSIVE SECURITY INTEGRATION**

**MANDATORY LOADING SEQUENCE:**
1. **THIS FILE** (ai-database-security-failsafe.mdc) - Always loaded, provides enforcement
2. **database-security-reference.mdc** - FORCE LOAD for implementation context
3. **security-database.mdc** - FORCE LOAD for core patterns

**TOKEN OPTIMIZATION:**
- This file: Lightweight enforcement and cross-file triggers
- database-security-reference.mdc: Intelligent loading with detailed examples
- security-database.mdc: Intelligent loading with core patterns

---

## ðŸ”’ MANDATORY VALIDATION CHECKLIST

### **PRE-CODE GENERATION (Complete ALL before coding):**
- [ ] Detected `$wpdb` pattern - confirmed need for security helper
- [ ] Added `get_db()` method to class if missing
- [ ] Selected correct security helper method
- [ ] Parameters formatted as arrays `[$param1, $param2]`
- [ ] Query type specified (`'get_var'`, `'get_results'`, `'get_row'`, `'get_col'`)

### **POST-CODE GENERATION (Validate IMMEDIATELY after coding):**
- [ ] **Syntax Check**: `php -l filename.php` passes
- [ ] **Pattern Scan**: Zero direct `$wpdb->method()` calls remain
- [ ] **Security Helper**: All database operations use `$this->get_db()`
- [ ] **Placeholders**: Used `%d`, `%s`, `%f` appropriately
- [ ] **No Vulnerabilities**: All dynamic data uses placeholders

---

## ðŸš¨ CRITICAL FAILURE CONDITIONS

**CODE IS INSECURE AND MUST BE REJECTED IF:**
- Any direct `$wpdb->method()` calls exist in user-facing code
- SQL injection vulnerabilities present
- Input not sanitized or output not escaped
- Security helper bypassed
- Validation checklist not completed

---

## ðŸŽ¯ QUICK DECISION TREE

```
Database operation needed?
â”œâ”€ YES â†’ Add get_db() method if missing
â”‚   â”œâ”€ SELECT query? â†’ Use query() with type parameter
â”‚   â”œâ”€ INSERT operation? â†’ Use insert() method
â”‚   â”œâ”€ UPDATE operation? â†’ Use update() method  
â”‚   â”œâ”€ DELETE operation? â†’ Use delete() method
â”‚   â”œâ”€ REPLACE operation? â†’ Use replace() method
â”‚   â””â”€ Complex query? â†’ Use exec() method
â””â”€ NO â†’ Continue with non-database code
```

---

## ðŸ›¡ï¸ SECURITY HELPER METHODS REFERENCE

```php
// Available methods in Dashboard_Security_Database class:
$this->get_db()->query($sql, $args, $type)           // SELECT operations
$this->get_db()->insert($table, $data, $formats)     // INSERT operations
$this->get_db()->update($table, $data, $where, $data_formats, $where_formats)
$this->get_db()->delete($table, $where, $where_formats)
$this->get_db()->replace($table, $data, $formats)    // REPLACE operations
$this->get_db()->exec($sql, $args)                   // Complex queries
$this->get_db()->bulk_insert($table, $rows)          // Bulk operations
$this->get_db()->create_table_secure($table, $schema) // Table creation
```

---

## âš¡ EMERGENCY PROTOCOLS

### **IF FORBIDDEN PATTERN DETECTED:**
```
1. HALT code generation immediately
2. OUTPUT: "SECURITY VIOLATION: Direct $wpdb usage detected"
3. APPLY: Correct security helper pattern from above
4. VALIDATE: Run post-generation checklist
5. RESUME: Only with secure implementation
```

### **IF SECURITY PATTERN CANNOT BE APPLIED:**
```
1. HALT code generation immediately  
2. OUTPUT: "SECURITY PATTERN REQUIRED: Cannot proceed"
3. REFERENCE: database-security-reference.mdc for complex implementation patterns
4. REQUEST: Human developer manual review if additional context insufficient
5. PROVIDE: Specific blocking reason
```

---

## ðŸ† SUCCESS VALIDATION

**Code is SECURE and ACCEPTABLE when:**
- âœ… All database operations use security helper
- âœ… Debug log shows `ðŸ›¡ï¸ DB-SEC` entries  
- âœ… No `$wpdb->method()` patterns remain
- âœ… Syntax validation passes
- âœ… Security checklist completed

**PROVEN EFFECTIVE: 100% success rate on Dashboard Plugin (42/42 operations secured)**

---

### **ðŸ”— MANDATORY CROSS-FILE REFERENCES**

**AI ASSISTANT MUST REFERENCE:**
- **database-security-reference.mdc**: MANDATORY for complex scenarios, migrations, error handling
- **security-database.mdc**: MANDATORY for core prepared statement patterns

**ENFORCEMENT PROTOCOL:**
```
Database operation detected?
â”œâ”€ YES â†’ FORCE LOAD database-security-reference.mdc
â”‚   â”œâ”€ FORCE LOAD security-database.mdc  
â”‚   â”œâ”€ Apply patterns from ALL files
â”‚   â”œâ”€ Use get_db() helper method
â”‚   â””â”€ Validate complete implementation
â””â”€ NO â†’ Continue with standard implementation
```

---

**Auto-Trigger**: Enabled for all `$wpdb` patterns  
**Enforcement**: MANDATORY - No exceptions  
**Validation**: Required before code completion  
**Success Rate**: 100% (Proven on Dashboard Plugin)  
**Intelligent Context**: For complex scenarios involving "migration", "error handling", "debug verification", or "implementation patterns", AI should reference database-security-reference.mdc
